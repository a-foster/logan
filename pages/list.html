<!DOCTYPE html>
<html>
<head>
  <title>SLIM</title>
  <script type='text/javascript' src='src/DataTables/jQuery-2.2.4/jquery-2.2.4.min.js'></script>
  <link rel='stylesheet' type='text/css' href='src/DataTables/datatables.min.css'/>
  <script type='text/javascript' src='src/DataTables/datatables.min.js'></script>
  <script type='text/javascript' src='src/DataTables/jquery.onScreenKeyboard.js'></script>
  <link rel='stylesheet' type='text/css' href='src/DataTables/onScreenKeyboard.css'/>

<script>
var base_endpoint = '../api/';

// set up basic stuff on page load
$(document).ready(function() {

  // setup item datatable
  $('#barcodes').DataTable({
    order: [[0, 'desc']],
    "iDisplayLength": 25
  });

  // add clear button to search field
  $('<span id="searchclear" class="glyphicon glyphicon-remove-circle"></span>').insertAfter($('input.input-sm'));
  $("#searchclear").click(function(){
    $("input.input-sm").val('');
  });

  // fetch all items and add them to the data table
  $.ajax({
    url: base_endpoint + 'shopping/get_items.php',
    type: 'GET',
    data: { },
    success: function(items) {
      for(var item in items) {
         this_item = items[item];
         item_added_tick = '';

         // if the item has been added to list, make sure we mark it with a tick
         if (this_item['item_added']) {
           item_added_tick = "<span class='item_sent glyphicon glyphicon-ok' style='color:green; margin-left: 3px;'></span>";
         }

         // add the row to the table
         $('#barcodes').DataTable().row.add([
           this_item['item_frequency'], this_item['item_category'], this_item['item_name'], "<input type='submit' onclick='add_item(this)' class='barcodes' product='" +
           this_item['item_name']+ "' category='" + this_item['item_category'] + "' value='Add to List'></td></tr><tr><td>" + item_added_tick
         ]).draw();
      }
    }
  });
})

var add_item = function(btn) {
	$('#list_created').remove();
	var this_button = $(btn)[0];
	var product_id = $(btn).attr('product').replace(/\W/g, '');

  // if it's not been added, add it
	if ($(btn).val() == 'Add to List') {
		$.ajax({
		  url: base_endpoint + 'shopping/add_to_list.php',
		  type: 'GET',
		  data: { item_name: $(btn).attr('product') },
		  success: function(result) {
				$(btn).val('Remove');
			  $("<span id='" + product_id + "_tick' class='item_sent glyphicon glyphicon-ok' style='color:green; margin-left: 3px;'></span>").insertAfter(this_button);
		  }
		});
	}

	// else we must want to remove item
	else {
    $.ajax({
		  url: base_endpoint + 'shopping/remove_from_list.php',
		  type: 'GET',
		  data: { item_name: $(btn).attr('product') },
		  success: function(result) {
        $('#' + product_id + '_tick').remove();
				$(btn).val('Add to List');
		  }
		});
	}
}

// TODO - refactor the following functions to use new base_endpoint
// will also need some logic to mark stuff as 'added' and work out who to send emails to
var create_list = function() {
  $.ajax({
	  url: base_endpoint + 'shopping/create_list.php',
	  type: 'GET',
	  data: {},
	  success: function(result) {

      // clear all added item ticks, append message and then reset all items as item_added=0
      $('.item_sent').remove();
			$('.barcodes').val('Add to List');
      $("<span class='item_sent glyphicon glyphicon-ok' style='color:green; margin-left: 3px;'></span>").insertAfter($('#create_list'));

      // TODO - This needs to update all items as not added, maybe 'remove_all_items.php', then could use that for the reset too
      $.ajax({
        url: base_endpoint + 'shopping/remove_all_items.php',
        type: 'GET',
        data: { request_type: 'refresh' },
				success: function(result) {
					// make sure page is refreshed, live.js can be a bit hit and miss
					location.reload();
				}
      });
	  }
	});
}
// TODO - Need a create_item endpoint and then add the row (like we do at the start) and mark with a tick
// NOTE - This is the 'new_product' function which previously used a new page, but I want it to be a modal really.

// TODO - this will need to open a modal or something with the current list build up and returned on the fly, might be difficult but cool!
var view_list = function() {
  $.ajax({
	  url: 'ajax_request.php',
	  type: 'GET',
	  data: { request_type: 'view_list' },
	  success: function(result) {
      window.open('current_list.html');
	  }
	});
}

var reset_list = function() {
  $.ajax({
	  url: 'ajax_request.php',
	  type: 'GET',
	  data: { request_type: 'reset_list' },
	  success: function(result) {
      location.reload();
	  }
	});
}

</script>
</head>
<body>

<p id='notice'></p>

<style>
#stuff {

    margin-top: 10px;
    margin-bottom: 100px;
    margin-right: 15px;
    margin-left: 15px;
		font-size: 20px;
}
</style>

<div id='stuff'>
<h1>Shopping List Item Manager</h1>
  <table id='barcodes'  width=100% class='table table-striped table-bordered sortable'>
  <thead>
  	<tr>
      <td>
        <input type='submit' id="create_list" onclick="create_list()" value="Create List" style="background-color:green; color:white;">
      </td>
      <td>
        <input type='submit' id="view_list" onclick="view_list()" value="View List" style="background-color:blue; color:white;">
      </td>
			<td>
				<input type='submit' id="reset_list" onclick="reset_list()" value="Reset List" style="background-color:red; color:white;">
			</td>
			<td>
				<input type='submit' id="add_product" onclick="window.open('new_item.html')" value="New Product" style="background-color:blue; color:white;">
			</td>
    </tr>
    <tr>
	  	<th>Frequency</th>
      <th>Category</th>
      <th>Product</th>
	  	<th>Add/ Remove Items</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</body>
</html>
